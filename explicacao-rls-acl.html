<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Como RLS e ACL Funcionam Juntos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .section h3 {
            color: #34495e;
            margin: 20px 0 10px 0;
            font-size: 1.4em;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .flow-diagram {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .flow-step {
            background: #3498db;
            color: white;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            display: inline-block;
            min-width: 150px;
        }

        .arrow {
            font-size: 2em;
            color: #3498db;
            margin: 0 10px;
        }

        .example-box {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .example-box h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .bitmask-explanation {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .bitmask-example {
            background: #34495e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .policy-explanation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .policy-explanation h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .step-by-step {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .step-by-step h4 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .step-by-step ol {
            padding-left: 20px;
        }

        .step-by-step li {
            margin: 8px 0;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .rls-policy {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .rls-policy .comment {
            color: #95a5a6;
        }

        .rls-policy .keyword {
            color: #e74c3c;
        }

        .rls-policy .function {
            color: #f39c12;
        }

        .rls-policy .string {
            color: #2ecc71;
        }

        .rls-policy .number {
            color: #9b59b6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Como RLS e ACL Funcionam Juntos</h1>
            <p>Explica√ß√£o Detalhada do Sistema de Controle de Acesso</p>
        </div>

        <div class="section">
            <h2>üéØ Conceito Geral</h2>
            <p><strong>Sim, voc√™ cria pol√≠ticas RLS baseadas na tabela ACL!</strong> O RLS (Row Level Security) √© o mecanismo do PostgreSQL que filtra automaticamente as linhas que um usu√°rio pode ver, e as pol√≠ticas RLS consultam a tabela ACL para determinar quais linhas o usu√°rio tem permiss√£o para acessar.</p>
            
            <div class="flow-diagram">
                <h3>üîÑ Fluxo de Funcionamento</h3>
                <div class="flow-step">Usu√°rio faz consulta</div>
                <span class="arrow">‚Üì</span>
                <div class="flow-step">PostgreSQL aplica RLS</div>
                <span class="arrow">‚Üì</span>
                <div class="flow-step">Pol√≠tica consulta ACL</div>
                <span class="arrow">‚Üì</span>
                <div class="flow-step">Retorna apenas dados permitidos</div>
            </div>
        </div>

        <div class="section">
            <h2>üèóÔ∏è Arquitetura do Sistema</h2>
            
            <div class="step-by-step">
                <h4>üìã Componentes Principais:</h4>
                <ol>
                    <li><strong>Tabela ACL</strong> - Armazena as permiss√µes (quem pode fazer o qu√™)</li>
                    <li><strong>Pol√≠ticas RLS</strong> - Regras que consultam a tabela ACL</li>
                    <li><strong>Fun√ß√£o set_current_user()</strong> - Define qual usu√°rio est√° logado</li>
                    <li><strong>Bitmask de Permiss√µes</strong> - Sistema de permiss√µes granular</li>
                </ol>
            </div>

            <div class="example-box">
                <h4>üí° Exemplo Pr√°tico:</h4>
                <p>Quando um usu√°rio faz <code>SELECT * FROM documents</code>, o PostgreSQL:</p>
                <ol>
                    <li>Identifica o usu√°rio atual via <code>current_setting('app.current_user_id')</code></li>
                    <li>Aplica a pol√≠tica RLS que consulta a tabela ACL</li>
                    <li>Retorna apenas os documentos que o usu√°rio tem permiss√£o de ler</li>
                </ol>
            </div>
        </div>

        <div class="section">
            <h2>üîç Como as Pol√≠ticas RLS Funcionam</h2>

            <div class="policy-explanation">
                <h4>üìã Estrutura de uma Pol√≠tica RLS:</h4>
                <p>Toda pol√≠tica RLS tem esta estrutura:</p>
                <ul>
                    <li><strong>FOR SELECT/INSERT/UPDATE/DELETE</strong> - Define qual opera√ß√£o a pol√≠tica controla</li>
                    <li><strong>USING</strong> - Condi√ß√£o que deve ser verdadeira para permitir acesso</li>
                    <li><strong>Consulta √† tabela ACL</strong> - Verifica se existe permiss√£o</li>
                </ul>
            </div>

            <div class="rls-policy">
                <div class="comment">-- Exemplo: Pol√≠tica de leitura para organiza√ß√µes</div>
                <div class="keyword">CREATE POLICY</div> org_read_policy <div class="keyword">ON</div> organizations
                <div class="keyword">    FOR SELECT</div>
                <div class="keyword">    USING</div> (
                <div class="keyword">        EXISTS</div> (
                <div class="keyword">            SELECT</div> <div class="number">1</div> <div class="keyword">FROM</div> acls
                <div class="keyword">            WHERE</div> subject_id = <div class="function">current_setting</div>(<div class="string">'app.current_user_id'</div>)::<div class="keyword">UUID</div>
                <div class="keyword">              AND</div> object_type = <div class="string">'organization'</div>
                <div class="keyword">              AND</div> object_id = organizations.id
                <div class="keyword">              AND</div> (perms & <div class="number">1</div>) = <div class="number">1</div>
                <div class="keyword">        )</div>
                <div class="keyword">    )</div>;
            </div>

            <div class="highlight">
                <h4>üîç Explica√ß√£o da Pol√≠tica:</h4>
                <ul>
                    <li><strong>current_setting('app.current_user_id')</strong> - Pega o ID do usu√°rio logado</li>
                    <li><strong>object_type = 'organization'</strong> - Filtra permiss√µes para organiza√ß√µes</li>
                    <li><strong>object_id = organizations.id</strong> - Verifica permiss√£o para esta organiza√ß√£o espec√≠fica</li>
                    <li><strong>(perms & 1) = 1</strong> - Verifica se tem permiss√£o de leitura (bit 1)</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üé≠ Sistema de Bitmask de Permiss√µes</h2>

            <div class="bitmask-explanation">
                <h4>üí° Como Funciona o Bitmask:</h4>
                <p>As permiss√µes s√£o representadas por bits:</p>
                <div class="bitmask-example">
                    <p>1 = READ   (00001) - Leitura</p>
                    <p>2 = WRITE  (00010) - Escrita</p>
                    <p>4 = APPROVE (00100) - Aprova√ß√£o</p>
                    <p>8 = SHARE  (01000) - Compartilhamento</p>
                    <p>16 = DELETE (10000) - Exclus√£o</p>
                    <p>31 = FULL  (11111) - Todas as permiss√µes</p>
                </div>
                <p>Para verificar se tem uma permiss√£o espec√≠fica:</p>
                <div class="bitmask-example">
                    <p>if (user_perms & 1) == 1 then user_can_read = true</p>
                    <p>if (user_perms & 2) == 2 then user_can_write = true</p>
                    <p>if (user_perms & 4) == 4 then user_can_approve = true</p>
                </div>
            </div>

            <div class="example-box">
                <h4>üìä Exemplos de Combina√ß√µes:</h4>
                <ul>
                    <li><strong>3</strong> = READ + WRITE (1 + 2)</li>
                    <li><strong>7</strong> = READ + WRITE + APPROVE (1 + 2 + 4)</li>
                    <li><strong>15</strong> = READ + WRITE + APPROVE + SHARE (1 + 2 + 4 + 8)</li>
                    <li><strong>31</strong> = Todas as permiss√µes (1 + 2 + 4 + 8 + 16)</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Heran√ßa de Permiss√µes em Cascata</h2>

            <div class="policy-explanation">
                <h4>üìÅ Pol√≠tica para Pastas (com heran√ßa):</h4>
                <p>As pol√≠ticas podem verificar permiss√µes em m√∫ltiplos n√≠veis da hierarquia:</p>
            </div>

            <div class="rls-policy">
                <div class="comment">-- Pol√≠tica de leitura para pastas com heran√ßa</div>
                <div class="keyword">CREATE POLICY</div> folder_read_policy <div class="keyword">ON</div> folders
                <div class="keyword">    FOR SELECT</div>
                <div class="keyword">    USING</div> (
                <div class="keyword">        EXISTS</div> (
                <div class="keyword">            SELECT</div> <div class="number">1</div> <div class="keyword">FROM</div> acls
                <div class="keyword">            WHERE</div> subject_id = <div class="function">current_setting</div>(<div class="string">'app.current_user_id'</div>)::<div class="keyword">UUID</div>
                <div class="keyword">              AND</div> (
                <div class="comment">                  -- Permiss√£o direta na pasta</div>
                <div class="keyword">                  (</div>object_type = <div class="string">'folder'</div> <div class="keyword">AND</div> object_id = folders.id <div class="keyword">AND</div> (perms & <div class="number">1</div>) = <div class="number">1</div><div class="keyword">)</div>
                <div class="keyword">                  OR</div>
                <div class="comment">                  -- Permiss√£o na √°rea pai</div>
                <div class="keyword">                  (</div>object_type = <div class="string">'area'</div> <div class="keyword">AND</div> object_id = folders.area_id <div class="keyword">AND</div> (perms & <div class="number">1</div>) = <div class="number">1</div><div class="keyword">)</div>
                <div class="keyword">                  OR</div>
                <div class="comment">                  -- Permiss√£o na organiza√ß√£o pai</div>
                <div class="keyword">                  (</div>object_type = <div class="string">'organization'</div> <div class="keyword">AND</div> object_id = (
                <div class="keyword">                      SELECT</div> organization_id <div class="keyword">FROM</div> areas <div class="keyword">WHERE</div> id = folders.area_id
                <div class="keyword">                  )</div> <div class="keyword">AND</div> (perms & <div class="number">1</div>) = <div class="number">1</div><div class="keyword">)</div>
                <div class="keyword">              )</div>
                <div class="keyword">        )</div>
                <div class="keyword">    )</div>;
            </div>

            <div class="success">
                <h4>‚úÖ Hierarquia de Heran√ßa:</h4>
                <p><strong>Organization ‚Üí Area ‚Üí Folder ‚Üí Document</strong></p>
                <p>Se um usu√°rio tem permiss√£o em um n√≠vel superior, automaticamente herda permiss√µes nos n√≠veis inferiores.</p>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Configura√ß√£o do Usu√°rio Atual</h2>

            <div class="code-block">
                <div class="comment">-- Fun√ß√£o para definir o usu√°rio atual</div>
                <div class="keyword">CREATE OR REPLACE FUNCTION</div> set_current_user(p_user_id <div class="keyword">UUID</div>)
                <div class="keyword">RETURNS VOID AS</div> $$
                <div class="keyword">BEGIN</div>
                    <div class="keyword">    PERFORM</div> set_config(<div class="string">'app.current_user_id'</div>, p_user_id::<div class="keyword">TEXT</div>, <div class="keyword">FALSE</div>);
                <div class="keyword">END</div>;
                $$ <div class="keyword">LANGUAGE</div> plpgsql;
            </div>

            <div class="example-box">
                <h4>üîß Como Usar:</h4>
                <ol>
                    <li>Antes de fazer consultas, execute: <code>SELECT set_current_user('user-uuid-here');</code></li>
                    <li>O PostgreSQL armazena o ID do usu√°rio em uma vari√°vel de sess√£o</li>
                    <li>As pol√≠ticas RLS usam essa vari√°vel para verificar permiss√µes</li>
                </ol>
            </div>
        </div>

        <div class="section">
            <h2>üìä Compara√ß√£o: RLS vs ACL</h2>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Aspecto</th>
                        <th>RLS (Row Level Security)</th>
                        <th>ACL (Access Control List)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Fun√ß√£o</strong></td>
                        <td>Mecanismo do PostgreSQL para filtrar linhas</td>
                        <td>Tabela que armazena as permiss√µes</td>
                    </tr>
                    <tr>
                        <td><strong>Onde √© definido</strong></td>
                        <td>Pol√≠ticas SQL no banco de dados</td>
                        <td>Dados na tabela acls</td>
                    </tr>
                    <tr>
                        <td><strong>Quando √© aplicado</strong></td>
                        <td>Automaticamente em todas as consultas</td>
                        <td>Consultado pelas pol√≠ticas RLS</td>
                    </tr>
                    <tr>
                        <td><strong>Performance</strong></td>
                        <td>Filtra no n√≠vel do banco (muito eficiente)</td>
                        <td>Consultado via JOIN/EXISTS</td>
                    </tr>
                    <tr>
                        <td><strong>Flexibilidade</strong></td>
                        <td>Limitada √†s pol√≠ticas SQL</td>
                        <td>Totalmente flex√≠vel (qualquer l√≥gica)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üéØ Exemplo Pr√°tico Completo</h2>

            <div class="step-by-step">
                <h4>üìã Cen√°rio: Usu√°rio tenta acessar documentos</h4>
                <ol>
                    <li><strong>Usu√°rio faz login:</strong> <code>SELECT set_current_user('11111111-1111-1111-1111-111111111111');</code></li>
                    <li><strong>Usu√°rio consulta documentos:</strong> <code>SELECT * FROM documents;</code></li>
                    <li><strong>PostgreSQL aplica RLS:</strong> Executa a pol√≠tica document_read_policy</li>
                    <li><strong>Pol√≠tica consulta ACL:</strong> Busca permiss√µes do usu√°rio na tabela acls</li>
                    <li><strong>Verifica heran√ßa:</strong> Checa permiss√µes em document ‚Üí folder ‚Üí area ‚Üí organization</li>
                    <li><strong>Retorna resultado:</strong> Apenas documentos que o usu√°rio pode ver</li>
                </ol>
            </div>

            <div class="example-box">
                <h4>üíæ Dados na Tabela ACL:</h4>
                <div class="code-block">
                    <div class="comment">-- Exemplo de registros ACL</div>
                    <div class="keyword">INSERT INTO</div> acls <div class="keyword">VALUES</div>
                    (<div class="string">'acl-1'</div>, <div class="string">'user-1'</div>, <div class="string">'organization'</div>, <div class="string">'org-1'</div>, <div class="number">31</div>), <div class="comment">-- Acesso total √† organiza√ß√£o</div>
                    (<div class="string">'acl-2'</div>, <div class="string">'user-2'</div>, <div class="string">'area'</div>, <div class="string">'area-1'</div>, <div class="number">7</div>), <div class="comment">-- READ+WRITE+APPROVE na √°rea</div>
                    (<div class="string">'acl-3'</div>, <div class="string">'user-3'</div>, <div class="string">'document'</div>, <div class="string">'doc-1'</div>, <div class="number">1</div>); <div class="comment">-- Apenas leitura do documento</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚úÖ Vantagens do Sistema</h2>

            <div class="success">
                <h4>üöÄ Benef√≠cios:</h4>
                <ul>
                    <li><strong>Seguran√ßa Autom√°tica:</strong> RLS aplica filtros automaticamente</li>
                    <li><strong>Performance:</strong> Filtragem no n√≠vel do banco de dados</li>
                    <li><strong>Flexibilidade:</strong> ACL permite permiss√µes granulares</li>
                    <li><strong>Heran√ßa:</strong> Permiss√µes em cascata na hierarquia</li>
                    <li><strong>Multi-tenancy:</strong> Isolamento total entre organiza√ß√µes</li>
                    <li><strong>Auditoria:</strong> Todas as consultas s√£o automaticamente filtradas</li>
                </ul>
            </div>

            <div class="warning">
                <h4>‚ö†Ô∏è Pontos de Aten√ß√£o:</h4>
                <ul>
                    <li><strong>Configura√ß√£o do usu√°rio:</strong> Sempre definir o usu√°rio atual antes das consultas</li>
                    <li><strong>Performance:</strong> Pol√≠ticas complexas podem impactar performance</li>
                    <li><strong>Debugging:</strong> Pode ser dif√≠cil debugar problemas de permiss√£o</li>
                    <li><strong>Manuten√ß√£o:</strong> Pol√≠ticas RLS precisam ser mantidas junto com a tabela ACL</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üéâ Conclus√£o</h2>
            <div class="highlight">
                <h4>üí° Resumo:</h4>
                <p><strong>Sim, voc√™ cria pol√≠ticas RLS baseadas na tabela ACL!</strong> O RLS √© o mecanismo que filtra automaticamente as linhas, e as pol√≠ticas RLS consultam a tabela ACL para determinar quais linhas o usu√°rio pode acessar. √â um sistema poderoso que combina a efici√™ncia do RLS com a flexibilidade do ACL.</p>
                
                <p>O sistema funciona assim:</p>
                <ol>
                    <li>Configure o usu√°rio atual com <code>set_current_user()</code></li>
                    <li>As pol√≠ticas RLS consultam a tabela ACL automaticamente</li>
                    <li>O PostgreSQL retorna apenas os dados permitidos</li>
                    <li>O sistema suporta heran√ßa de permiss√µes em cascata</li>
                </ol>
            </div>
        </div>
    </div>
</body>
</html>
